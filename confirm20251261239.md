* 

---

## 1️⃣ 发给 Codex 的“任务说明”模版（你只要改 API_KEY 等）

> 你现在需要帮我改造现有后端代码，支持调用 Gemini 3 Pro Preview 多模态大模型，输入为图片文件。
> 具体要求如下：
>
> 1. 使用 Python + `google-generativeai` 官方 SDK 调用 Gemini API。
> 2. 模型名称使用：`gemini-3.0-pro-preview`
> 3. 输入为图片文件：后端从本地路径或上传文件对象中读取二进制数据，转换为 bytes，并通过 `inlineData` 的方式传给模型，而不是 URL。
> 4. 封装一个通用函数，例如：
>
>    ```python
>    def analyze_image_with_gemini(image_path, prompt):
>        ...
>        return response_text
>    ```
>
>    * `image_path`: 本地图片路径（字符串）
>    * `prompt`: 文本提示，比如“请帮我解析这张卡牌的内容并输出结构化结果”
>    * 返回值为模型生成的文本内容（`response.text` 或拼接后的字符串）。
> 5. 将 API Key 从环境变量 `GEMINI_API_KEY` 中读取，而不是写死在代码里；如果 key 不存在，要抛出清晰的异常说明。
> 6. 添加一个最小可运行示例：当直接运行该文件时，从固定路径（例如 `./sample/card.jpg`）读取图片，并打印模型返回结果。
> 7. 请注意：
>
>    * 图片作为 `inlineData` 传入，`mime_type` 按实际类型设置（可先假设为 `"image/jpeg"`）。
>    * 请求结构中，需要把文字 prompt 与图片一起作为 `contents` / `parts` 传递。
>    * 保证代码结构清晰，可复用，便于后续集成到 FastAPI / Flask。
> 8. 请输出完整的 Python 代码文件内容。

> 下面是你可以参考的调用方式（你在此基础上帮我完善与封装）：
>
> ```python
> from google import generativeai as genai
> import os
>
> API_KEY = os.getenv("GEMINI_API_KEY")
> if not API_KEY:
> 	raise RuntimeError("GEMINI_API_KEY environment variable not set")
>
> genai.configure(api_key=API_KEY)
>
> MODEL_NAME = "gemini-3.0-pro-preview"  # 如果不可用，可回退为其他多模态模型
>
> def analyze_image_with_gemini(image_path, prompt):
> 	# 1. 读取图片为 bytes
> 	with open(image_path, "rb") as f:
> 		image_bytes = f.read()
>
> 	# 2. 构建模型
> 	model = genai.GenerativeModel(MODEL_NAME)
>
> 	# 3. 组合文本 + 图片输入
> 	response = model.generate_content(
> 		[
> 			{"text": prompt},
> 			{
> 				"inline_data": {
> 					"mime_type": "image/jpeg",
> 					"data": image_bytes
> 				}
> 			}
> 		]
> 	)
>
> 	return response.text
>
> if __name__ == "__main__":
> 	test_image = "./sample/card.jpg"
> 	test_prompt = "请帮我解析这张卡牌的内容，并用简体中文输出。"
> 	print(analyze_image_with_gemini(test_image, test_prompt))
> ```
>
> 注意：如果 `inline_data` 字段在当前 SDK 版本名称有差异（例如叫 `inlineData` 或通过 `genai.upload_file` 处理），请根据最新 `google-generativeai` SDK 的用法自动调整，但保持整体封装结构不变。

---



> 在 `analyze_image_with_gemini` 的基础上，再封装一个专门用于「性格色彩卡牌」解析的函数：
>
> ```python
> def analyze_card_image(image_path):
> 	prompt = (
> 		"你是一名专业的性格色彩分析师。"
> 		"请阅读图片中的卡牌文字，并输出 JSON："
> 		"{\"cards\": [{\"index\": 序号, \"color\": 颜色, \"keyword_cn\": 中文关键词, \"keyword_en\": 英文关键词, \"score\": 分值}]}"
> 		"如果无法识别某些字段，请用 null 填充。"
> 	)
> 	return analyze_image_with_gemini(image_path, prompt)
> ```
>
> 


